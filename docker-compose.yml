services:
  db:
    image: ${MYSQL_IMAGE:?missing MYSQL_IMAGE}
    restart: unless-stopped
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: ${DB_NAME:?missing DB_NAME}
      MYSQL_USER: ${DB_USER:?missing DB_USER}
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_user_password
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/mysql-init:/docker-entrypoint-initdb.d:ro
      - ./database/schemas:/dbfiles/schemas:ro
      - ./database/initialization:/dbfiles/initialization:ro
    secrets:
      - mysql_root_password
      - mysql_user_password
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p\"$$(cat /run/secrets/mysql_root_password)\" --silent"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - internal

  db-expose:
    image: ${SOCAT_IMAGE:-alpine/socat}
    restart: unless-stopped
    profiles:
      - dev
    depends_on:
      db:
        condition: service_healthy
    command: ["TCP-LISTEN:3306,fork,reuseaddr", "TCP:db:3306"]
    ports:
      - "127.0.0.1:${DB_PORT:?missing DB_PORT}:3306"
    networks:
      - internal

  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_IMAGE: ${NODE_IMAGE:?missing NODE_IMAGE}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PORT: 3001
      DB_HOST: db
      DB_USER: ${DB_USER:?missing DB_USER}
      DB_NAME: ${DB_NAME:?missing DB_NAME}
      DB_PASSWORD_FILE: /run/secrets/mysql_user_password
      AI_API: ${AI_API:-}
      AI_MODEL: ${AI_MODEL:-}
      AI_API_KEY_FILE: /run/secrets/ai_api_key
      AI_TIMEOUT_MS: ${AI_TIMEOUT_MS:-120000}
      AI_RETRIES: ${AI_RETRIES:-2}
      AI_INSECURE_TLS: ${AI_INSECURE_TLS:-0}
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    secrets:
      - mysql_user_password
      - ai_api_key
    networks:
      - internal

  proxy:
    image: ${CADDY_IMAGE:?missing CADDY_IMAGE}
    restart: unless-stopped
    depends_on:
      - web
    environment:
      DOMAIN: ${DOMAIN:?missing DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - internal
      - public

volumes:
  db_data:
  caddy_data:
  caddy_config:

secrets:
  mysql_root_password:
    file: ./secrets/mysql_root_password.txt
  mysql_user_password:
    file: ./secrets/mysql_user_password.txt
  ai_api_key:
    file: ./secrets/ai_api_key.txt

networks:
  internal:
    internal: true
  public:
